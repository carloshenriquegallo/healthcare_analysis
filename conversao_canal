-- Taxa de conversão por canal
-- Conversão = prescrições vendidas / prescrições visualizadas
SELECT
    canalvenda,
    SUM(CASE WHEN visualizadapaciente = TRUE THEN 1 ELSE 0 END) AS prescricoes_visualizadas,
    SUM(CASE WHEN itemvendido > 0 THEN 1 ELSE 0 END) AS prescricoes_vendidas,
    ROUND(
        SUM(CASE WHEN itemvendido > 0 THEN 1 ELSE 0 END)::DECIMAL
        / NULLIF(SUM(CASE WHEN visualizadapaciente = TRUE THEN 1 ELSE 0 END), 0) * 100,
    2) AS taxa_conversao_percent
FROM public.prescricaomedicamento
GROUP BY canalvenda
ORDER BY taxa_conversao_percent DESC;
